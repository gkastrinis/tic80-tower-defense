function BOOT()
	UI={
		tower=256,towerOK=256,towerFire=258,
		skull=264,bat=266,smoke1=292,smoke2=294,
		money=262,hp=260,hover=290,
		mapX=0,mapY=0
	}
	Game={
		over=false,
		path1={{16,0},{16,88},{104,88},{104,56}},
		path2={{200,106},{200,16},{104,16},{104,56}},
		time=0
	}
	Enemies={}
	SFX={}
	HQ={x=104,y=58,hp=12,gold=5}
	-- Path3={112,1,112,48}
end

function Remap(tile,x,y)
	local flip,rotate=0,0
	if (x==33 and y>=0 and y<=10) or
		(x==44 and y>=4 and y<=6) or
		(x==44 and y>=10 and y<=11) or
		(x==56 and y>=3 and y<=14) then
		flip=1
	elseif (x>=34 and x<=42 and y==11) or
		(x>=44 and x<=55 and y==2) or
		(x>=45 and x<=47 and y==8) then
		rotate=1
	elseif (x>=33 and x<=43 and y==12) or
		(x>=45 and x<=54 and y==3) then
		rotate=3; flip=1
	elseif (x==43 and y==11) or (x==44 and y==12) then
		flip=1
	elseif (x==43 and y==2) or (x==44 and y==3) then
		rotate=1
	elseif (x==56 and y==2) or (x==55 and y==3) then
		rotate=1; flip=1
	elseif x==48 and y==8 then
		rotate=1; flip=1
	elseif x==45 and y==7 then
		flip=1
	elseif x==42 and y==8 then
		rotate=1; flip=1
	elseif x==42 and y==9 then
		rotate=3
	elseif x>=43 and x<=45 and y==9 then
		rotate=2
	end
	return tile,flip,rotate
end

function TIC()
	Input()
	Update()
	Draw()

	local mx,my,a,b,c,d,e,f=mouse()
	-- if mx==nil then ;
	-- else print(mx.." "..my,64,126) end
	local xMod,yMod=math.fmod(mx,8),math.fmod(my,8)
	-- spr(UI.hover,mx-xMod,my-yMod,0)
end

function Input()
	-- if btnp(4) then HQ.hp=HQ.hp-1 end
	-- if btnp(5) then HQ.hp=HQ.hp+1 end
end

function Update()
	UpdateSFX()
	if not Game.over then
		UpdateEnemies()
		UpdateGame()
	end
end

function UpdateSFX()
	for i,f in ipairs(SFX) do
		if f.type == "shake" then
			if f.x>0 then f.x = f.x-1 end
			if f.y>0 then f.y = f.y-1 end
			UI.mapX = f.x
			UI.mapY = f.y
			if f.x==0 and f.y==0 then table.remove(SFX,i) end
		elseif f.type == "visual" and f.kind == "smoke" then
			if math.fmod(f.t,4)==0 then
				f.x = f.x-1
				f.y = f.y-1
			end
			if f.id == UI.smoke1 and f.t == 4 then f.id = UI.smoke2 end
			f.t = f.t-1
			if f.t == 0 then table.remove(SFX,i) end
		end
	end
end

function UpdateEnemies()
	if Game.time == 0 then
		local en={id=UI.skull, p=Game.path1,idx=1,flip=1}
		en.x = en.p[en.idx][1]
		en.y = en.p[en.idx][2]
		table.insert(Enemies, en)
	elseif Game.time == 60 then
		local en={id=UI.bat, p=Game.path2, idx=1, flip=1}
		en.x = en.p[en.idx][1]
		en.y = en.p[en.idx][2]
		table.insert(Enemies, en)
	end

	for i,e in ipairs(Enemies) do
		local p,idx = e.p,e.idx
		if e.idx == #p then
			HitHQ(i)
		else
			local aX,aY,bX,bY = p[idx][1],p[idx][2],p[idx+1][1],p[idx+1][2]
			if aX == bX then
				if aY < bY then e.y = e.y+1 else e.y = e.y-1 end
			else
				if aX < bX then e.x = e.x+1 else e.x = e.x-1 end
			end
			if e.x == bX and e.y == bY then e.idx = idx+1 end
		end
	end
end

function UpdateGame()
	if HQ.hp == 0 then
		UI.tower = UI.towerFire
		Game.over = true
		UI.mapX = 0
		UI.mapY = 0
	else
		Game.time = Game.time<120 and Game.time+1 or 0
	end
end

function HitHQ(i)
	HQ.hp = HQ.hp-1
	table.remove(Enemies, i)
	table.insert(SFX, {type="shake", x=3, y=3})
	table.insert(SFX, {type="visual", kind="smoke", id=UI.smoke1, x=HQ.x, y=HQ.y, t=10})
end

function Draw()
	map(30,0,30,17,UI.mapX,UI.mapY,-1,1,Remap)
	spr(UI.tower,HQ.x,HQ.y,0,1,0,0,2,2)

	DrawSFX()

	if not Game.over then
		DrawHP()
		spr(UI.money,0,120,0,1,0,0,2,2)
		print(HQ.gold,16,124,12,false,2)

		DrawEnemies()
	else
		print("Game Over",68,124,2,false,2)
	end
end

function DrawSFX()
	for i,f in ipairs(SFX) do
		if f.type == "visual" then
			spr(f.id,f.x,f.y,0,1,0,0,2,2)
		end
	end
end

function DrawHP()
	local fullHearts = math.floor(HQ.hp/4)
	for i=1, fullHearts do
		spr(UI.hp,240-16*i,120,0,1,0,0,2,2)
	end
	local rest,restX = math.fmod(HQ.hp,4),240-16*fullHearts-8
	if rest == 1 then
		spr(UI.hp+1,restX,120,0,1,0,0,1,1)
	elseif rest == 2 then
		spr(UI.hp+1,restX,120,0,1,0,0,1,2)
	elseif rest == 3 then
		spr(UI.hp,restX-8,120,0,1,0,0,1,1)
		spr(UI.hp+1,restX,120,0,1,0,0,1,2)
	end
end

function DrawEnemies()
	for i,e in ipairs(Enemies) do
		spr(e.id,e.x,e.y,0,1,e.flip,0,2,2)
	end
end

-- <TILES>
-- 016:6766666677766666777666666366766666677766666777666666366666666666
-- 017:667feeee667feeec667feeec667feeec667feeec667feeec667feeee667feeee
-- 018:6666ffff666ff33366ff33446ff33444ff334444f3344444f3444444f3444444
-- 019:ffffffff33333333444444444444444444444444444444444444444444444444
-- 020:4444444444444444444444444444444444444444444444444444444444444444
-- 032:6666666666666666666666666666666666666666666666666666666666666666
-- 033:667feeee667feeee667feeee667feeee667feeee667feeee667feeee667feeee
-- 034:eeeef766eeeef776eeeeff77eeeeefffeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
-- 048:7434c44773344447734c4d477444de477444e4477444444774ed44c774e44c47
-- 049:667feeee667feeee6677feee66677fee666677ff666667776666666666666666
-- 050:eeeeeecceeeeeecceeeeeeeeeeeeeeeeffffffff777777776666666666666666
-- 064:744444e77444c3e374c44433744444447e444c447fee444467fe444c66777777
-- </TILES>

-- <SPRITES>
-- 000:00000000000e0ee0000eeeee000ddddd0e0edede0eeeeeee0ddddd2c0d84dd2c
-- 001:00000000e0e0f000eeeef000dddff000edeff0f0eeeefff02ddddff02d84ddf0
-- 002:00000000000e0ee0000eeeee000ddddd0e0edede0eeeee2e0dddd2220dffdd22
-- 003:00000000e0002000eee23020dd234200ee2342f02eeef2f01ddddff01dffddf0
-- 004:0000000000000000000000000012220000222220012222220122222201222222
-- 005:00000000000000000000000002221000222220002cc2220022cc2200222c2200
-- 006:0000000000000044000000440000444400044433000443000004440000034444
-- 007:0000000000000000000000004400000044400000344000000330000044000000
-- 008:00000000000000000000222200022ccc0002cccc0022cccc002c32cc002c32cc
-- 009:00000000000000002222000044422000c4432000cc4422003244320032443200
-- 010:00000000000000000000000000000222000002f2222002ff2ff222ff211ff2ff
-- 011:0000000000000000000000000222000022f2000022f22222fff2fff2fffff112
-- 016:0d89dd220d89ddd20d88dddd0dddddff0ddddfef0d7ddfef0777dfff77777766
-- 017:2d89dff0dd89dff0dd88ddf0fddddff0efdddff0efdddf70ffddd77066677777
-- 018:0df2d2220df2d2320dff22320dd223320dd233430d723443077734c4777773c4
-- 019:1d8fdff0d2ffdff0d2ffddf02ddddff022dddff032dddf7032ddd77036677777
-- 020:0112222200122222001122220001122200001122000001120000001100000000
-- 021:2222220022222000222220002222000022200000220000002000000000000000
-- 022:0000344400000333000440000004440000034444000033440000004400000033
-- 023:4440000034400000044000004440000044300000330000000000000000000000
-- 024:002ccc3c0022cc3c00022ccc00024343000244c4000224440000222200000000
-- 025:cc443200c4433200c343220044422000c4320000422200002200000000000000
-- 026:2211fff40211fff40221ffff00211fff00212fff002222ff0000022200000000
-- 027:ff4f1112ff411122fff11220fff11200fff21200ff2222002220000000000000
-- 032:0011111101100000110000001000000010000000100000001000000010000000
-- 033:1111110000000110000000110000000100000001000000010000000100000001
-- 034:0111111010000001100000011000000110000001100000011000000101111110
-- 035:0000000000344400034222400343324003433240034332400034440000000000
-- 036:000000000000ffff00fff1120ff22244ff244344f2344334f1334443f1334444
-- 037:00000000ff0000002ff0000041ff0000432f0000322f000032ff00001ff00000
-- 038:0000000000000fff0000ff220000f2440ffff244ff221234f3444443f333443f
-- 039:00000000ff0000001ff0000041ff0000432f0000322f000022ff0000fff00000
-- 048:1000000010000000100000001000000010000000110000000110000000111111
-- 049:0000000100000001000000010000000100000001000000110000011011111100
-- 050:000000000ff0ff00fc3f32f0f33322f00f332f0000f2f000000f000000000000
-- 051:0044420004233420423423424244424242444242423423420423342000444200
-- 052:ff2233440ffff234000f3344000f3444000ff3440000ff3200000fff00000000
-- 053:41ff0000441f0000442f0000442f000022ff0000fff00000f000000000000000
-- 054:f223341fff2211f00fffff0f000000ff00000ff200000f2400000ff3000000ff
-- 055:0000000000000000fff0000021ff0000441f0000322f000022ff0000fff00000
-- 064:0ffffff0ffcccddffcccccdf02c22cdffcfcccdffccccdff0fcfcdf00ffffff0
-- 065:000002330000224200324320ccccc320fcfcc420cfcc3200ccc3200003420000
-- 066:0ffffff0f222221ff323221ff323211ff222211ffcc2211ff2f211ff0ffffff0
-- 080:000002000002200000ffff000ffffff0ffcffcffffcffcff0ffffff000ffff00
-- 081:0000040000044000002222000222222022322322223223220222222000222200
-- 082:000dd00000dddd000dddddd00ecddce00eeeeee0008008000808808080800808
-- 083:000000003003000343043043444444434ee4ee434444444344eee44344ede443
-- </SPRITES>

-- <MAP>
-- 000:010101010101010101010101010103010101010101010101010101010101010111110101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:010101020202020202020202020203020202020202020202020202020101010111110202020202020202020201020102020202020202020202020101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:010102020202020202020202020203020202020202020202020201020101010111110202020202020202021312111111111111111111111213020101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:010202020202020202020202020103010202020202020202020202020201010211110202020201020202021222111111111111111111112212020201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:010202020102020202020202020203020102020202020204030304020201010211110102020102020202021111020202010202020202021111020201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:010202020102020202020202010203010102020202020203020103020201010211110102020202020202011111020102020202020202021111020201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:010202020202020202020201020203020201020202020203020203020201010211110202020202020201021111020201020202020102021111020201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:030303040202020204030303030302030303030402020203020203010201010211110202020202020202213131210102020102020202021111010201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:010201030202020203020202020202020202020403030304020203020201010211110202020202020202314141310303040202020202021111020201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:010202030202020203020202020202020202020202020202020203020201010211110202020202020202213131210202030202020202021111020201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:010202030202020203020202020202020202010202020202020203020101010211110202020202020202021111020202030201020202021111020101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:010202040303030304010202020202020201020202020202020203020201010212221111111111111111112212020202030102020202021111020201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:010202020202020202020202020202020202020202020202020203020201010213121111111111111111111213020202030202020202021111020201000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:010202020201010101020202020201020202020202020101020203020101010202020201010101020202020201020202030202020101021111020101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:010101010101010101010101010101010101010101010101010103010101010101010101010101010101010101010101030101010101011111010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <TRACKS>
-- 000:100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </TRACKS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>
